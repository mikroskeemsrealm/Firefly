From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mark Vainomaa <mikroskeem@mikroskeem.eu>
Date: Tue, 26 Nov 2019 19:51:00 +0200
Subject: [PATCH] Attempt to make supported protocol id checking faster


diff --git a/protocol/src/main/java/net/md_5/bungee/protocol/ProtocolConstants.java b/protocol/src/main/java/net/md_5/bungee/protocol/ProtocolConstants.java
index f33bb5c4c17486fa50cb20eaacb2bb8f6aa2cf54..e02fa9b6ad24b550880254a282460da0b61a0fbe 100644
--- a/protocol/src/main/java/net/md_5/bungee/protocol/ProtocolConstants.java
+++ b/protocol/src/main/java/net/md_5/bungee/protocol/ProtocolConstants.java
@@ -71,6 +71,28 @@ public class ProtocolConstants
             ProtocolConstants.MINECRAFT_1_16_2,
             ProtocolConstants.MINECRAFT_1_16_3
     );
+    // Firefly start
+    public static final int LOWEST_SUPPORTED_VERSION_ID;
+    public static final int HIGHEST_SUPPORTED_VERSION_ID;
+    private static final boolean[] SUPPORTED_VERSION_IDS_FAST;
+    static {
+        LOWEST_SUPPORTED_VERSION_ID = SUPPORTED_VERSION_IDS.get(0);
+        HIGHEST_SUPPORTED_VERSION_ID = SUPPORTED_VERSION_IDS.get(SUPPORTED_VERSION_IDS.size() - 1);
+        var arraySize = HIGHEST_SUPPORTED_VERSION_ID - LOWEST_SUPPORTED_VERSION_ID + 1;
+        SUPPORTED_VERSION_IDS_FAST = new boolean[arraySize];
+        for (var supportedVersionId : SUPPORTED_VERSION_IDS) {
+            var index = supportedVersionId - LOWEST_SUPPORTED_VERSION_ID;
+            SUPPORTED_VERSION_IDS_FAST[index] = true;
+        }
+    }
+
+    public static boolean isSupportedProtocol(int protocolId) {
+        var protocolIndex = protocolId - LOWEST_SUPPORTED_VERSION_ID;
+        return protocolIndex >= 0 &&
+                protocolIndex < ProtocolConstants.SUPPORTED_VERSION_IDS_FAST.length &&
+                ProtocolConstants.SUPPORTED_VERSION_IDS_FAST[protocolIndex];
+    }
+    // Firefly end
 
     public static final boolean isBeforeOrEq(int before, int other)
     {
diff --git a/proxy/src/main/java/net/md_5/bungee/BungeeCord.java b/proxy/src/main/java/net/md_5/bungee/BungeeCord.java
index 3a3c2fbd39874de0991571fa1f4c84aedc42b68c..476636ee2ced03825d6233fc0d7e584c0ebed595 100644
--- a/proxy/src/main/java/net/md_5/bungee/BungeeCord.java
+++ b/proxy/src/main/java/net/md_5/bungee/BungeeCord.java
@@ -808,7 +808,7 @@ public class BungeeCord extends ProxyServer
     @Override
     public int getProtocolVersion()
     {
-        return ProtocolConstants.SUPPORTED_VERSION_IDS.get( ProtocolConstants.SUPPORTED_VERSION_IDS.size() - 1 );
+        return ProtocolConstants.HIGHEST_SUPPORTED_VERSION_ID; //SUPPORTED_VERSION_IDS.get( ProtocolConstants.SUPPORTED_VERSION_IDS.size() - 1 ); // Firefly
     }
 
     @Override
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
index c69ed1d989d023a895cde8b27c8c4ea50ee2b505..2415630448283eae4c5ea28ded01172b8a16c746 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
@@ -237,7 +237,7 @@ public class InitialHandler extends PacketHandler implements PendingConnection
 
         ServerInfo forced = AbstractReconnectHandler.getForcedHost( this );
         final String motd = ( forced != null ) ? forced.getMotd() : listener.getMotd();
-        final int protocol = ( ProtocolConstants.SUPPORTED_VERSION_IDS.contains( handshake.getProtocolVersion() ) ) ? handshake.getProtocolVersion() : bungee.getProtocolVersion();
+        final int protocol = ( ProtocolConstants.isSupportedProtocol(/*SUPPORTED_VERSION_IDS.contains(*/ handshake.getProtocolVersion() ) ) ? handshake.getProtocolVersion() : bungee.getProtocolVersion(); // Firefly
 
         Callback<ServerPing> pingBack = new Callback<ServerPing>()
         {
@@ -340,7 +340,7 @@ public class InitialHandler extends PacketHandler implements PendingConnection
                 thisState = State.USERNAME;
                 ch.setProtocol( Protocol.LOGIN );
 
-                if ( !ProtocolConstants.SUPPORTED_VERSION_IDS.contains( handshake.getProtocolVersion() ) )
+                if ( !ProtocolConstants.isSupportedProtocol(handshake.getProtocolVersion())) //.SUPPORTED_VERSION_IDS.contains( handshake.getProtocolVersion() ) ) // Firefly
                 {
                     if ( handshake.getProtocolVersion() > bungee.getProtocolVersion() )
                     {
