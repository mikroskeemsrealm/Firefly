From 1c472889c9f5779b3282b0739774c7aefae05d71 Mon Sep 17 00:00:00 2001
From: Mark Vainomaa <mikroskeem@mikroskeem.eu>
Date: Wed, 29 May 2019 13:15:28 +0300
Subject: [PATCH] Add option to exclude logging invalid query packets


diff --git a/api/src/main/java/net/md_5/bungee/api/ProxyConfig.java b/api/src/main/java/net/md_5/bungee/api/ProxyConfig.java
index 67a33110..2a6e8730 100644
--- a/api/src/main/java/net/md_5/bungee/api/ProxyConfig.java
+++ b/api/src/main/java/net/md_5/bungee/api/ProxyConfig.java
@@ -257,4 +257,10 @@ public interface ProxyConfig
      */
     java.util.Set<String> getIgnoredLogCommands();
     // MikroCord end
+    // MikroCord start - Add option to exclude logging invalid query packets
+    /**
+     * @return Whether invalid query packets should be logged or not
+     */
+    boolean isLogInvalidQueryPackets();
+    // MikroCord end
 }
diff --git a/proxy/src/main/java/eu/mikroskeem/mikrocord/conf/MikroCordConfiguration.java b/proxy/src/main/java/eu/mikroskeem/mikrocord/conf/MikroCordConfiguration.java
index 000a9861..a8d6c8e3 100644
--- a/proxy/src/main/java/eu/mikroskeem/mikrocord/conf/MikroCordConfiguration.java
+++ b/proxy/src/main/java/eu/mikroskeem/mikrocord/conf/MikroCordConfiguration.java
@@ -22,6 +22,9 @@ public class MikroCordConfiguration extends WaterfallConfiguration {
     @Getter
     private Set<String> ignoredLogCommands;
 
+    @Getter
+    private boolean logInvalidQueryPackets = false;
+
     @Override
     public void load() {
         super.load();
diff --git a/query/src/main/java/net/md_5/bungee/query/QueryHandler.java b/query/src/main/java/net/md_5/bungee/query/QueryHandler.java
index b6b20f36..7b6cdcea 100644
--- a/query/src/main/java/net/md_5/bungee/query/QueryHandler.java
+++ b/query/src/main/java/net/md_5/bungee/query/QueryHandler.java
@@ -69,6 +69,7 @@ public class QueryHandler extends SimpleChannelInboundHandler<DatagramPacket>
         ByteBuf in = msg.content();
         if ( in.readUnsignedByte() != 0xFE || in.readUnsignedByte() != 0xFD )
         {
+            if (bungee.getConfig().isLogInvalidQueryPackets()) // MikroCord - Add option to exclude logging invalid query packets
             bungee.getLogger().log( Level.WARNING, "Query - Incorrect magic!: {0}", msg.sender() );
             return;
         }
@@ -96,6 +97,7 @@ public class QueryHandler extends SimpleChannelInboundHandler<DatagramPacket>
             QuerySession session = sessions.getIfPresent( msg.sender().getAddress() );
             if ( session == null || session.getToken() != challengeToken )
             {
+                if (!bungee.getConfig().isLogInvalidQueryPackets()) return; // MikroCord - Add option to exclude logging invalid query packets
                 throw new IllegalStateException( "No session!" );
             }
 
-- 
2.22.1

