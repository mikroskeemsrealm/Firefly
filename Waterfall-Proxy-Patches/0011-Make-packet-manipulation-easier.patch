From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mark Vainomaa <mikroskeem@mikroskeem.eu>
Date: Sat, 13 Apr 2019 20:13:53 +0300
Subject: [PATCH] Make packet manipulation easier


diff --git a/api/src/main/java/eu/mikroskeem/mikrocord/api/network/ChannelHolder.java b/api/src/main/java/eu/mikroskeem/mikrocord/api/network/ChannelHolder.java
new file mode 100644
index 0000000000000000000000000000000000000000..834540a496667512a542969cbede2265e15652cc
--- /dev/null
+++ b/api/src/main/java/eu/mikroskeem/mikrocord/api/network/ChannelHolder.java
@@ -0,0 +1,10 @@
+package eu.mikroskeem.mikrocord.api.network;
+
+import io.netty.channel.Channel;
+
+/**
+ * @author Mark Vainomaa
+ */
+public interface ChannelHolder {
+    Channel getChannel();
+}
diff --git a/api/src/main/java/net/md_5/bungee/api/connection/Connection.java b/api/src/main/java/net/md_5/bungee/api/connection/Connection.java
index bfafaa863b2f4072b4718e6ef641270023821778..7aaa48261bac7123c2bb66bc135ecf21215ce435 100644
--- a/api/src/main/java/net/md_5/bungee/api/connection/Connection.java
+++ b/api/src/main/java/net/md_5/bungee/api/connection/Connection.java
@@ -9,7 +9,7 @@ import net.md_5.bungee.protocol.DefinedPacket;
  * It should expose information about the remote peer, however not be specific
  * to a type of connection, whether server or player.
  */
-public interface Connection
+public interface Connection extends eu.mikroskeem.mikrocord.api.network.ChannelHolder // MikroCord - make packet manipulation easier
 {
 
     /**
diff --git a/protocol/src/main/java/net/md_5/bungee/protocol/Protocol.java b/protocol/src/main/java/net/md_5/bungee/protocol/Protocol.java
index 44dc34ff1ec4ec42fe52559ed2a9237ff6114c21..7c21c01f4d11be04869313974be245aeb3d3302e 100644
--- a/protocol/src/main/java/net/md_5/bungee/protocol/Protocol.java
+++ b/protocol/src/main/java/net/md_5/bungee/protocol/Protocol.java
@@ -383,8 +383,8 @@ public enum Protocol
     /*========================================================================*/
     public static final int MAX_PACKET_ID = 0xFF;
     /*========================================================================*/
-    final DirectionData TO_SERVER = new DirectionData( this, ProtocolConstants.Direction.TO_SERVER );
-    final DirectionData TO_CLIENT = new DirectionData( this, ProtocolConstants.Direction.TO_CLIENT );
+    public final DirectionData TO_SERVER = new DirectionData( this, ProtocolConstants.Direction.TO_SERVER ); // MikroCord - make packet manipulation easier
+    public final DirectionData TO_CLIENT = new DirectionData( this, ProtocolConstants.Direction.TO_CLIENT ); // MikroCord - make packet manipulation easier
 
     public static void main(String[] args)
     {
@@ -421,7 +421,7 @@ public enum Protocol
     }
 
     @Data
-    private static class ProtocolData
+    public static class ProtocolData // MikroCord - make packet manipulation easier
     {
 
         private final int protocolVersion;
@@ -430,7 +430,7 @@ public enum Protocol
     }
 
     @Data
-    private static class ProtocolMapping
+    public static class ProtocolMapping // MikroCord - make packet manipulation easier
     {
 
         private final int protocolVersion;
@@ -438,16 +438,18 @@ public enum Protocol
     }
 
     // Helper method
-    private static ProtocolMapping map(int protocol, int id)
+    public static ProtocolMapping map(int protocol, int id) // MikroCord - make packet manipulation easier
     {
         return new ProtocolMapping( protocol, id );
     }
 
-    static final class DirectionData
+    public static final class DirectionData // MikroCord - make packet manipulation easier
     {
 
+        @Getter // MikroCord - make packet manipulation easier
         private final TIntObjectMap<ProtocolData> protocols = new TIntObjectHashMap<>();
         //
+        @Getter // MikroCord - make packet manipulation easier
         private final Protocol protocolPhase;
         @Getter
         private final ProtocolConstants.Direction direction;
@@ -463,7 +465,7 @@ public enum Protocol
             }
         }
 
-        private ProtocolData getProtocolData(int version)
+        public ProtocolData getProtocolData(int version) // MikroCord - make packet manipulation easier
         {
             ProtocolData protocol = protocols.get( version );
             if ( protocol == null && ( protocolPhase != Protocol.GAME ) )
@@ -504,7 +506,7 @@ public enum Protocol
             }
         }
 
-        private <P extends DefinedPacket> void registerPacket(Class<P> packetClass, java.util.function.Supplier<P> constructor, ProtocolMapping... mappings) // Waterfall - speed up packet construction
+        public <P extends DefinedPacket> void registerPacket(Class<P> packetClass, java.util.function.Supplier<P> constructor, ProtocolMapping... mappings) // Waterfall - speed up packet construction // MikroCord - make packet manipulation easier
         {
             // Waterfall start - speed up packet construction
             /*
@@ -549,7 +551,7 @@ public enum Protocol
              */ // Waterfall end
         }
         // Waterfall start - speed up packet construction (backwards compat)
-        private <P extends DefinedPacket> void registerPacket(Class<P> packetClass, ProtocolMapping... mappings) {
+        public <P extends DefinedPacket> void registerPacket(Class<P> packetClass, ProtocolMapping... mappings) { // MikroCord - make packet manipulation easier
             java.util.function.Supplier<P> packetSupplier;
             try {
                 Constructor<? extends DefinedPacket> constructor = packetClass.getDeclaredConstructor();
@@ -567,7 +569,7 @@ public enum Protocol
         }
         // Waterfall end
 
-        final int getId(Class<? extends DefinedPacket> packet, int version)
+        public final int getId(Class<? extends DefinedPacket> packet, int version) // MikroCord - make packet manipulation easier
         {
 
             ProtocolData protocolData = getProtocolData( version );
diff --git a/proxy/src/main/java/net/md_5/bungee/ServerConnection.java b/proxy/src/main/java/net/md_5/bungee/ServerConnection.java
index d11d601ec6a6afdca731a2b0db1655993e3119ad..789a8ec127b1058277831ad794c5cafa75ab8c61 100644
--- a/proxy/src/main/java/net/md_5/bungee/ServerConnection.java
+++ b/proxy/src/main/java/net/md_5/bungee/ServerConnection.java
@@ -12,7 +12,7 @@ import net.md_5.bungee.protocol.DefinedPacket;
 import net.md_5.bungee.protocol.packet.PluginMessage;
 
 @RequiredArgsConstructor
-public class ServerConnection implements Server
+public class ServerConnection implements Server, eu.mikroskeem.mikrocord.api.network.ChannelHolder // MikroCord - make packet manipulation easier
 {
 
     @Getter
@@ -80,4 +80,10 @@ public class ServerConnection implements Server
     {
         return unsafe;
     }
+    // MikroCord start - make packet manipulation easier
+    @Override
+    public io.netty.channel.Channel getChannel() {
+        return ch.getHandle();
+    }
+    // MikroCord end
 }
diff --git a/proxy/src/main/java/net/md_5/bungee/ServerConnector.java b/proxy/src/main/java/net/md_5/bungee/ServerConnector.java
index 00cd477f0c0fcd1c740c1f5b422c86172a9baf7b..cfcc1b39b33c205ebd86f91ff5bcb569d85151fa 100644
--- a/proxy/src/main/java/net/md_5/bungee/ServerConnector.java
+++ b/proxy/src/main/java/net/md_5/bungee/ServerConnector.java
@@ -54,7 +54,7 @@ import net.md_5.bungee.util.BufUtil;
 import net.md_5.bungee.util.QuietException;
 
 @RequiredArgsConstructor
-public class ServerConnector extends PacketHandler
+public class ServerConnector extends PacketHandler implements eu.mikroskeem.mikrocord.api.network.ChannelHolder // MikroCord - make packet manipulation easier
 {
 
     private final ProxyServer bungee;
@@ -440,4 +440,10 @@ public class ServerConnector extends PacketHandler
     {
         return "[" + user.getName() + "|" + user.getAddress() + "] <-> ServerConnector [" + target.getName() + "]";
     }
+    // MikroCord start - make packet manipulation easier
+    @Override
+    public io.netty.channel.Channel getChannel() {
+        return ch.getHandle();
+    }
+    // MikroCord end
 }
diff --git a/proxy/src/main/java/net/md_5/bungee/UserConnection.java b/proxy/src/main/java/net/md_5/bungee/UserConnection.java
index b4cbc3f37d76edc4c3c156f3ee52c04d114504a3..5d6022071d23197c584271560edf1ba14668c1b4 100644
--- a/proxy/src/main/java/net/md_5/bungee/UserConnection.java
+++ b/proxy/src/main/java/net/md_5/bungee/UserConnection.java
@@ -66,7 +66,7 @@ import net.md_5.bungee.util.CaseInsensitiveSet;
 import net.md_5.bungee.util.ChatComponentTransformer;
 
 @RequiredArgsConstructor
-public final class UserConnection implements ProxiedPlayer
+public final class UserConnection implements ProxiedPlayer, eu.mikroskeem.mikrocord.api.network.ChannelHolder // MikroCord - make packet manipulation easier
 {
 
     /*========================================================================*/
@@ -747,4 +747,10 @@ public final class UserConnection implements ProxiedPlayer
         return entityRewrite == net.md_5.bungee.entitymap.EntityMap_Dummy.INSTANCE;
     }
     // Waterfall end
+    // MikroCord start - make packet manipulation easier
+    @Override
+    public io.netty.channel.Channel getChannel() {
+        return ch.getHandle();
+    }
+    // MikroCord end
 }
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
index 8e637718e94e88fa5afd154c0ab95510b91acecc..b1fdaf9b76a26a4356c61eb2975e28fd4eabef05 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
@@ -640,4 +640,10 @@ public class InitialHandler extends PacketHandler implements PendingConnection
     {
         return !ch.isClosed();
     }
+    // MikroCord start - make packet manipulation easier
+    @Override
+    public io.netty.channel.Channel getChannel() {
+        return ch.getHandle();
+    }
+    // MikroCord end
 }
