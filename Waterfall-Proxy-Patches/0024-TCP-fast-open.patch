From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mark Vainomaa <mikroskeem@mikroskeem.eu>
Date: Wed, 29 May 2019 20:02:24 +0300
Subject: [PATCH] TCP fast open


diff --git a/api/src/main/java/eu/mikroskeem/mikrocord/api/config/MikroCordProxyConfig.java b/api/src/main/java/eu/mikroskeem/mikrocord/api/config/MikroCordProxyConfig.java
index 04a0bf7d9ec95502d751ee796ef297423212d0cf..ccba966265138d86cacf60ef989db71f17efe893 100644
--- a/api/src/main/java/eu/mikroskeem/mikrocord/api/config/MikroCordProxyConfig.java
+++ b/api/src/main/java/eu/mikroskeem/mikrocord/api/config/MikroCordProxyConfig.java
@@ -1,5 +1,6 @@
 package eu.mikroskeem.mikrocord.api.config;
 
+import eu.mikroskeem.mikrocord.api.network.TCPFastOpenMode;
 import org.checkerframework.checker.nullness.qual.NonNull;
 
 import java.util.Set;
@@ -40,4 +41,15 @@ public interface MikroCordProxyConfig {
      * @return Velocity modern forwarding secret
      */
     byte @NonNull [] getVelocityForwardingSecret();
+
+    /**
+     * @return Whether TCP Fast Open is enabled or not
+     */
+    boolean isTcpFastOpenEnabled();
+
+    /**
+     * @return TCP Fast Open mode
+     */
+    @NonNull
+    TCPFastOpenMode getTcpFastOpenMode();
 }
diff --git a/api/src/main/java/eu/mikroskeem/mikrocord/api/network/TCPFastOpenMode.java b/api/src/main/java/eu/mikroskeem/mikrocord/api/network/TCPFastOpenMode.java
new file mode 100644
index 0000000000000000000000000000000000000000..56e1518bd87c762daff17d0585751ea3a19709b6
--- /dev/null
+++ b/api/src/main/java/eu/mikroskeem/mikrocord/api/network/TCPFastOpenMode.java
@@ -0,0 +1,29 @@
+package eu.mikroskeem.mikrocord.api.network;
+
+/**
+ * See https://en.wikipedia.org/wiki/TCP_Fast_Open
+ *
+ * @author Mark Vainomaa
+ */
+public enum TCPFastOpenMode {
+    DISABLED(0),
+    CLIENT_ONLY(1),
+    SERVER_ONLY(2),
+    BOTH(3),
+    ;
+
+    public final int value;
+
+    TCPFastOpenMode(int value) {
+        this.value = value;
+    }
+
+    public static TCPFastOpenMode fromValue(int value) {
+        for (var enumValue : TCPFastOpenMode.values()) {
+            if (enumValue.value == value)
+                return enumValue;
+        }
+
+        return DISABLED;
+    }
+}
diff --git a/proxy/src/main/java/eu/mikroskeem/mikrocord/conf/MikroCordConfiguration.java b/proxy/src/main/java/eu/mikroskeem/mikrocord/conf/MikroCordConfiguration.java
index 5b0b1c5e730bb857616cb39598f96ee0904582aa..1df8934ab767a27f1e8a4e49816d79200024ece7 100644
--- a/proxy/src/main/java/eu/mikroskeem/mikrocord/conf/MikroCordConfiguration.java
+++ b/proxy/src/main/java/eu/mikroskeem/mikrocord/conf/MikroCordConfiguration.java
@@ -1,6 +1,7 @@
 package eu.mikroskeem.mikrocord.conf;
 
 import com.google.common.collect.ImmutableList;
+import eu.mikroskeem.mikrocord.api.network.TCPFastOpenMode;
 import eu.mikroskeem.mikrocord.misc.VelocitySupport;
 import io.github.waterfallmc.waterfall.conf.WaterfallConfiguration;
 import lombok.Getter;
@@ -10,6 +11,7 @@ import net.md_5.bungee.api.config.ConfigurationAdapter;
 import java.nio.charset.StandardCharsets;
 import java.util.HashSet;
 import java.util.Set;
+import java.util.logging.Level;
 
 /**
  * @author Mark Vainomaa
@@ -33,6 +35,12 @@ public class MikroCordConfiguration extends WaterfallConfiguration {
     @Getter
     private byte[] velocityForwardingSecret;
 
+    @Getter
+    private boolean tcpFastOpenEnabled = true;
+
+    @Getter
+    private TCPFastOpenMode tcpFastOpenMode = TCPFastOpenMode.CLIENT_ONLY;
+
     @Override
     public void load() {
         super.load();
@@ -45,5 +53,13 @@ public class MikroCordConfiguration extends WaterfallConfiguration {
         logInvalidQueryPackets = config.getBoolean("log.invalid_query_packets", logInvalidQueryPackets);
         velocityForwardingSupport = config.getBoolean("velocity_modern_forwarding.enabled", velocityForwardingSupport);
         velocityForwardingSecret = config.getString("velocity_modern_forwarding.secret", () -> VelocitySupport.generateRandomString(12)).getBytes(StandardCharsets.UTF_8);
+        tcpFastOpenEnabled = config.getBoolean("networking.tcp_fast_open.enabled", tcpFastOpenEnabled);
+        tcpFastOpenMode = setupTfo(config.getInt("networking.tcp_fast_open.mode", tcpFastOpenMode.value));
+    }
+
+    private TCPFastOpenMode setupTfo(int value) {
+        var actual = TCPFastOpenMode.fromValue(value);
+        ProxyServer.getInstance().getLogger().log(Level.INFO, "TCP fast open mode is set to {0}", actual.name());
+        return actual;
     }
 }
diff --git a/proxy/src/main/java/net/md_5/bungee/netty/PipelineUtils.java b/proxy/src/main/java/net/md_5/bungee/netty/PipelineUtils.java
index 4ad17d1a53b594e8af55fe3b84e13aa780ad8c11..e56219f8b8fbde57568e0a911a7cc64b9f5b06a5 100644
--- a/proxy/src/main/java/net/md_5/bungee/netty/PipelineUtils.java
+++ b/proxy/src/main/java/net/md_5/bungee/netty/PipelineUtils.java
@@ -82,6 +82,11 @@ public class PipelineUtils
                 ch.close();
                 return;
             }
+            // MikroCord start - TCP fast open
+            if (epoll && BungeeCord.getInstance().getConfig().isTcpFastOpenEnabled()) {
+                ch.config().setOption(io.netty.channel.epoll.EpollChannelOption.TCP_FASTOPEN, BungeeCord.getInstance().getConfig().getTcpFastOpenMode().value);
+            }
+            // MikroCord end
             ch.pipeline().addBefore( FRAME_DECODER, LEGACY_DECODER, new LegacyDecoder() );
             ch.pipeline().addAfter( FRAME_DECODER, PACKET_DECODER, new MinecraftDecoder( Protocol.HANDSHAKE, true, ProxyServer.getInstance().getProtocolVersion() ) );
             ch.pipeline().addAfter( FRAME_PREPENDER, PACKET_ENCODER, new MinecraftEncoder( Protocol.HANDSHAKE, true, ProxyServer.getInstance().getProtocolVersion() ) );
